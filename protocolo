import pandas as pd
from PIL import Image, ImageDraw, ImageFont
import os

# Configurações de Caminhos
INPUT_EXCEL = "CONTROLE_DEVOLUCOES.xlsx"
MODELO_PATH = "assets/modelo_protocolo.png"
ASSINATURA_PATH = "assets/assinatura.png"
OUTPUT_DIR = "protocolos_gerados"

# Criar pasta de saída se não existir
if not os.path.exists(OUTPUT_DIR):
    os.makedirs(OUTPUT_DIR)

def gerar_protocolos():
    try:
        # Carregar dados
        df = pd.read_excel(INPUT_EXCEL)
        
        for index, linha in df.iterrows():
            # Abrir imagem base
            with Image.open(MODELO_PATH).convert("RGB") as img:
                draw = ImageDraw.Draw(img)
                
                # Use uma fonte padrão do sistema ou coloque o .ttf na pasta assets
                try:
                    fonte = ImageFont.truetype("arial.ttf", 20)
                except:
                    fonte = ImageFont.load_default()

                # Preenchimento dos campos (Coordenadas X, Y aproximadas)
                # Você deve ajustar esses números baseando-se em pixels
                draw.text((800, 45), f"{linha['protocolo']}", fill="black", font=fonte)
                draw.text((100, 145), str(linha['cliente']), fill="black", font=fonte)
                draw.text((150, 240), str(linha['nota_fiscal']), fill="black", font=fonte)
                draw.text((550, 240), str(linha['cte']), fill="black", font=fonte)
                
                # Inserir Assinatura Digital
                if os.path.exists(ASSINATURA_PATH):
                    assinatura = Image.open(ASSINATURA_PATH).convert("RGBA")
                    # Redimensiona a assinatura para caber no campo
                    assinatura = assinatura.resize((250, 80))
                    img.paste(assinatura, (150, 550), assinatura)

                # Salvar resultado
                nome_final = f"Protocolo_{linha['protocolo']}.png"
                img.save(os.path.join(OUTPUT_DIR, nome_final))
                print(f"Sucesso: {nome_final} gerado.")

    except Exception as e:
        print(f"Erro ao processar: {e}")

if __name__ == "__main__":
    gerar_protocolos()
